sap.ui.define([
	"sap/ui/core/mvc/Controller",
	"sap/m/TablePersoController",
	"sap/m/MessageBox",
	"sap/ui/core/util/Export",
	"sap/ui/core/util/ExportTypeCSV",
	"sap/m/MessageToast",
	"ZODD_HOURS_S2D/model/formatter"
], function(Controller, TablePersoController, MessageBox, Export, ExportTypeCSV, MessageToast, formatter) {
	"use strict";
	return Controller.extend("ZODD_HOURS_S2D.controller.View3", {
		/**
		 *@memberOf ODD_HOURS.controller.View1
		 */
		  formatter: formatter,
		onInit: function() {
			// MessageToast.show("REPORT");
			this.readData();
			this._oRouter = this.getOwnerComponent().getRouter();
			this._oRouter.getRoute("View3").attachPatternMatched(this._onObjectMatched, this);
		},
		_onObjectMatched: function(oEvent) {
			//If any values were passed in the URL then those will be available in oArgs
			//Do other stuff here
			this.readData();
			
		},
		readData: function() {
			var that = this;
			var oModel = this.getOwnerComponent().getModel("Approver");
			//Converting odata model to JSON Model
			var mParams = {
				success: function(odata) {
					var data = odata.results;
					var jm = new sap.ui.model.json.JSONModel();
					jm.setData(data);
					that.getView().byId("approver").getBinding("items").refresh(true);
					that.getView().setModel(jm);
				}
			};
			var eset = "/APPROVERSet";
			oModel.read(eset, mParams);
		},
		/**
		 *@memberOf ODD_HOURS.controller.View2
		 */
		goBack: function() {
			//This code was generated by the layout editor.
			jQuery.sap.history.back();
		},
		onSave: function() {
			var oMod = this.getOwnerComponent().getModel("Model");
			oMod.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);
			sap.ui.core.BusyIndicator.show();
			var ese = "/ODD_DETAILSSet(EMP_ID='";
			var s = this.getView().byId("approver").getItems();
			var changeSetId = "foo";
			oMod.setUseBatch(true);
			oMod.setDeferredGroups(["foo"]);
			//Prep header-level group/changeset params
			var that = this;
			var mParameters = {
				"groupId": changeSetId,
					async: false,
				success: function() {
					sap.ui.core.BusyIndicator.hide();
					sap.m.MessageToast.show("Data Saved");
					var oM = that.getOwnerComponent().getModel("Approver");
					var mParams = {
						async: false,
						success: function(odata) {
							var data = odata.results;
							var jm = new sap.ui.model.json.JSONModel();
							jm.setData(data);
							/*that.getView().byId("approver").getModel().refresh(true);
							that.getView().byId("approver").setModel(oM);*/
							that.getView().byId("approver").getBinding("items").refresh(true);
							that.getView().setModel(oM);
						}
					};
					var eset = "/APPROVERSet";
					oM.read(eset, mParams);
				},
				error: function() {
				}
			};
			var mParams = {
				groupId: "foo",
				async: false,
				success: function() {

				},
				error: function() {

				}
			};
			for (var i = 0; i < s.length; i++) {
				var g = s[i].getCells();
				var id = g[0].getText();
				var date = g[2].getText();
				var hours = g[5].getValue();
				var state = g[6].getState();
				var app;
				if (state === true) {
					app = "APPROVED";
				} else {
					app = "REJECTED";
				}
				var oentry = {};
				var temp = new Date(date);
				var y = temp.getFullYear();
				var m = temp.getMonth() + 1;
				var str = m;
				if (m < 10)
				str = "0" + m;
				m = str;
				str = "";
				var d = temp.getDate();
				if(d < 10)
				{
				str = "0" + d;
				d = str;
				}
				date = "";
				y= y.toString();
				m = m.toString();
				d = d.toString();
				date = y + m + d;
				oentry.EMP_ID = id;
			    oentry.DATE = date;
				oentry.EMP_NAME = "";
				oentry.EMP_EMAIL_ID = "";
				oentry.HOURS = hours;
				oentry.WBS_CODE = "";
				oentry.PROJECT = "";
				oentry.STATUS = app;
				oentry.APP_EMAIL_ID = "";
				var yese = ese + id + "',DATE='" + date + "')";
				oMod.update(yese, oentry, mParams);
				oMod.setRefreshAfterChange(true);
				oentry = "";
			}
			oMod.submitChanges(mParameters);
		}
	});
});